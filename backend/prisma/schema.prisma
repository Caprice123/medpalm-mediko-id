generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model constants {
  id         Int      @id @default(autoincrement())
  key        String   @unique
  value      String
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  @@index([key])
}

model credit_plans {
  id                  Int                   @id @default(autoincrement())
  name                String
  description         String?
  credits             Int
  price               Decimal               @db.Decimal(10, 2)
  isActive            Boolean               @default(true)
  isPopular           Boolean               @default(false)
  discount            Int                   @default(0)
  order               Int                   @default(0)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now())
  credit_transactions credit_transactions[]
}

model credit_transactions {
  id               Int           @id @default(autoincrement())
  userId           Int
  userCreditId     Int
  type             String
  amount           Int
  balanceBefore    Int
  balanceAfter     Int
  description      String?
  creditPlanId     Int?
  sessionId        Int?
  paymentStatus    String?
  paymentMethod    String?
  paymentReference String?
  createdAt        DateTime      @default(now())
  credit_plans     credit_plans? @relation(fields: [creditPlanId], references: [id])
  user_credits     user_credits  @relation(fields: [userCreditId], references: [id])

  @@index([paymentStatus])
  @@index([type])
  @@index([userCreditId])
  @@index([userId])
}

model exercise_questions {
  id              Int             @id @default(autoincrement())
  topic_id        Int
  question        String
  answer          String
  explanation     String
  order           Int             @default(0)
  created_at      DateTime        @default(now())
  updated_at      DateTime        @default(now())
  exercise_topics exercise_topics @relation(fields: [topic_id], references: [id], onDelete: Cascade)

  @@index([order])
  @@index([topic_id])
}

model exercise_sessions {
    id                       Int                        @id @default(autoincrement())
    user_learning_session_id Int                        @unique
    exercise_topic_id        Int?
    total_question           Int
    credits_used             Int                        @default(0)
    number_of_attempts       Int                        @default(0)
    created_at               DateTime                   @default(now())
    updated_at               DateTime                   @default(now())
    
    exercise_session_attempts   exercise_session_attempts[]
    user_learning_session       user_learning_sessions          @relation(fields: [user_learning_session_id], references: [id], onDelete: Cascade)
    exercise_session_questions  exercise_session_questions[]
    exercise_topic              exercise_topics?                @relation(fields: [exercise_topic_id], references: [id])

    @@index([user_learning_session_id])
    @@index([exercise_topic_id])
}


model exercise_session_questions {
    id                           Int                        @id @default(autoincrement())
    exercise_session_id          Int
    question_text                String
    answer_text                  String
    explanation                  String
    order                        Int
    created_at                   DateTime                   @default(now())

    exercise_session             exercise_sessions  @relation(fields: [exercise_session_id], references: [id], onDelete: Cascade)
    exercise_session_answers     exercise_session_answers[]

    @@index([order])
}

model exercise_session_attempts {
    id                          Int                           @id @default(autoincrement())
    exercise_session_id         Int
    attempt_number              Int                           @default(1)
    status                      String                        @default("not_started")
    correct_question            Int?
    total_question              Int?
    score                       Int                           @default(0)
    started_at                  DateTime                      @default(now())
    completed_at                DateTime?
    created_at                  DateTime                      @default(now())
    updated_at                  DateTime                      @default(now())

    exercise_session_answers    exercise_session_answers[]
    exercise_session            exercise_sessions             @relation(fields: [exercise_session_id], references: [id], onDelete: Cascade)

    @@index([exercise_session_id])
    @@index([started_at])
    @@index([status])
}


model exercise_session_answers {
    id                           Int                          @id @default(autoincrement())
    exercise_session_attempt_id  Int
    exercise_session_question_id Int
    user_answer                  String
    is_correct                   Boolean
    answered_at                  DateTime                     @default(now())
    time_taken_seconds           Int?

    exercise_session_attempts    exercise_session_attempts    @relation(fields: [exercise_session_attempt_id], references: [id], onDelete: Cascade)
    exercise_session_questions   exercise_session_questions   @relation(fields: [exercise_session_question_id], references: [id], onDelete: Cascade)

    @@index([answered_at])
    @@index([exercise_session_attempt_id])
    @@index([exercise_session_question_id])
}

model exercise_topic_tags {
    id              Int             @id @default(autoincrement())
    topic_id        Int
    tag_id          Int
    created_at      DateTime        @default(now())
    tags            tags            @relation(fields: [tag_id], references: [id], onDelete: Cascade)
    exercise_topics exercise_topics @relation(fields: [topic_id], references: [id], onDelete: Cascade)

    @@unique([topic_id, tag_id])
    @@index([tag_id])
    @@index([topic_id])
}

model exercise_topics {
  id                        Int                        @id @default(autoincrement())
  title                     String
  description               String?
  content_type              String
  content                   String?
  pdf_url                   String?
  pdf_key                   String?
  pdf_filename              String?
  status                    String                     @default("draft")
  is_active                 Boolean                    @default(true)
  created_by                Int
  created_at                DateTime                   @default(now())
  updated_at                DateTime                   @default(now())
  
  exercise_session          exercise_sessions[]
  exercise_questions        exercise_questions[]
  exercise_topic_tags       exercise_topic_tags[]

  @@index([created_by])
  @@index([is_active])
  @@index([status])
}

model tags {
  id                  Int                   @id @default(autoincrement())
  name                String
  type                String
  is_active           Boolean               @default(true)
  created_at          DateTime              @default(now())
  updated_at          DateTime              @default(now())
  exercise_topic_tags exercise_topic_tags[]
  flashcard_deck_tags flashcard_deck_tags[]
  summary_note_tags   summary_note_tags[]

  @@unique([name, type])
  @@index([is_active])
  @@index([type])
}

model user_credits {
  id                  Int                   @id @default(autoincrement())
  userId              Int                   @unique
  balance             Int                   @default(0)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now())
  credit_transactions credit_transactions[]

  @@index([userId])
}

model user_learning_sessions {
  id                   Int                    @id @default(autoincrement())
  user_id              Int
  title                String
  type                 String                 @default("exercise")
  created_at           DateTime               @default(now())
  updated_at           DateTime               @default(now())

  exercise_session     exercise_sessions?
  flashcard_session    flashcard_sessions?
  summary_note_session summary_note_sessions?

  @@index([title])
  @@index([type])
  @@index([user_id])
}

model flashcard_decks {
  id                      Int                       @id @default(autoincrement())
  title                   String
  description             String?
  content_type            String
  content                 String?
  pdf_url                 String?
  pdf_key                 String?
  pdf_filename            String?
  status                  String                    @default("draft")
  is_active               Boolean                   @default(true)
  created_by              Int
  created_at              DateTime                  @default(now())
  updated_at              DateTime                  @default(now())

  flashcard_cards         flashcard_cards[]
  flashcard_deck_tags     flashcard_deck_tags[]
  flashcard_sessions      flashcard_sessions[]

  @@index([created_by])
  @@index([is_active])
  @@index([status])
}

model flashcard_cards {
  id              Int              @id @default(autoincrement())
  deck_id         Int
  front           String
  back            String
  order           Int              @default(0)
  created_at      DateTime         @default(now())
  updated_at      DateTime         @default(now())

  flashcard_decks flashcard_decks  @relation(fields: [deck_id], references: [id], onDelete: Cascade)

  @@index([deck_id])
  @@index([order])
}

model flashcard_deck_tags {
  id              Int              @id @default(autoincrement())
  deck_id         Int
  tag_id          Int
  created_at      DateTime         @default(now())

  flashcard_decks flashcard_decks  @relation(fields: [deck_id], references: [id], onDelete: Cascade)
  tags            tags             @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([deck_id, tag_id])
  @@index([deck_id])
  @@index([tag_id])
}

model flashcard_sessions {
  id                       Int                          @id @default(autoincrement())
  user_learning_session_id Int                          @unique
  flashcard_deck_id        Int?
  total_cards              Int
  credits_used             Int                          @default(0)
  created_at               DateTime                     @default(now())
  updated_at               DateTime                     @default(now())

  user_learning_session        user_learning_sessions       @relation(fields: [user_learning_session_id], references: [id], onDelete: Cascade)
  flashcard_deck               flashcard_decks?             @relation(fields: [flashcard_deck_id], references: [id])
  flashcard_session_cards      flashcard_session_cards[]

  @@index([user_learning_session_id])
  @@index([flashcard_deck_id])
}

model flashcard_session_cards {
  id                      Int                       @id @default(autoincrement())
  flashcard_session_id    Int
  original_card_id        Int?                      // references flashcard_cards.id for progress tracking
  front_text              String
  back_text               String
  order                   Int
  created_at              DateTime                  @default(now())

  flashcard_session           flashcard_sessions        @relation(fields: [flashcard_session_id], references: [id], onDelete: Cascade)

  @@index([flashcard_session_id])
  @@index([order])
  @@index([original_card_id])
}

// Track user progress per card across all sessions
model user_card_progress {
  id              Int      @id @default(autoincrement())
  user_id         Int
  card_id         Int      // references flashcard_cards.id
  times_correct   Int      @default(0)
  times_incorrect Int      @default(0)
  last_reviewed   DateTime @default(now())
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  @@unique([user_id, card_id])
  @@index([user_id])
  @@index([card_id])
}

model user_sessions {
  id           Int      @id @default(autoincrement())
  userId       Int
  token        String   @unique
  isActive     Boolean  @default(true)
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model users {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  picture   String?
  googleId  String?  @unique
  role      String   @default("user")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}

// ============= Summary Notes Feature =============

model summary_notes {
  id                     Int                     @id @default(autoincrement())
  title                  String
  description            String?
  content                String                  @db.Text

  // Source document info
  source_type            String?                 // 'pdf', 'pptx', 'docx', 'manual'
  source_url             String?
  source_key             String?
  source_filename        String?

  status                 String                  @default("draft")
  is_active              Boolean                 @default(true)
  created_by             Int
  created_at             DateTime                @default(now())
  updated_at             DateTime                @default(now())

  summary_note_tags      summary_note_tags[]
  summary_note_sessions  summary_note_sessions[]

  @@index([created_by])
  @@index([is_active])
  @@index([status])
}

model summary_note_tags {
  id              Int           @id @default(autoincrement())
  summary_note_id Int
  tag_id          Int
  created_at      DateTime      @default(now())

  summary_note    summary_notes @relation(fields: [summary_note_id], references: [id], onDelete: Cascade)
  tags            tags          @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([summary_note_id, tag_id])
  @@index([summary_note_id])
  @@index([tag_id])
}

model summary_note_sessions {
  id                       Int                    @id @default(autoincrement())
  user_learning_session_id Int                    @unique
  summary_note_id          Int
  credits_used             Int                    @default(0)
  viewed_at                DateTime               @default(now())
  created_at               DateTime               @default(now())

  user_learning_session    user_learning_sessions @relation(fields: [user_learning_session_id], references: [id], onDelete: Cascade)
  summary_note             summary_notes          @relation(fields: [summary_note_id], references: [id])

  @@index([user_learning_session_id])
  @@index([summary_note_id])
}

// ============= Platform Statistics =============

model statistics {
  id                 Int      @id @default(autoincrement())
  key                String   @unique
  value              Int      @default(0)
  updated_at         DateTime @default(now()) @updatedAt

  @@index([key])
}

// ============= Pricing Plans (Unified Bundles) =============

model pricing_plans {
  id                  Int                  @id @default(autoincrement())
  code                String?              @unique
  name                String
  description         String?
  price               Decimal              @db.Decimal(10, 2)
  bundle_type         String               @default("credits")  // credits, subscription, hybrid
  duration_days       Int?                 // for subscription/hybrid bundles
  credits_included    Int                  @default(0)
  is_active           Boolean              @default(true)
  is_popular          Boolean              @default(false)
  discount            Int                  @default(0)
  order               Int                  @default(0)
  created_at          DateTime             @default(now())
  updated_at          DateTime             @default(now())

  user_purchases      user_purchases[]

  @@index([is_active])
  @@index([bundle_type])
  @@index([order])
  @@index([name])
  @@index([code])
  @@index([is_active, bundle_type, order])
}

model user_purchases {
  id                    Int                @id @default(autoincrement())
  user_id               Int
  pricing_plan_id       Int
  bundle_type           String             // credits, subscription, hybrid
  purchase_date         DateTime           @default(now())

  // Subscription fields (for subscription/hybrid bundles)
  subscription_start    DateTime?
  subscription_end      DateTime?
  subscription_status   String?            // active, expired, cancelled

  // Credits fields
  credits_granted       Int                @default(0)

  // Payment fields
  payment_status        String             @default("completed")
  payment_method        String?
  payment_reference     String?
  amount_paid           Decimal            @db.Decimal(10, 2)

  created_at            DateTime           @default(now())
  updated_at            DateTime           @default(now())

  pricing_plan          pricing_plans      @relation(fields: [pricing_plan_id], references: [id])

  @@index([user_id])
  @@index([pricing_plan_id])
  @@index([bundle_type])
  @@index([subscription_status])
  @@index([subscription_end])
}

// ============= Features Configuration =============

model features {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  icon         String?
  access_type  String   @default("free")  // free, subscription, credits, subscription_and_credits
  credit_cost  Int      @default(0)
  is_active    Boolean  @default(true)
  order        Int      @default(0)
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now())

  @@index([is_active])
  @@index([access_type])
  @@index([order])
}
