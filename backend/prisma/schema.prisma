generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model constants {
  id         Int      @id @default(autoincrement())
  key        String   @unique
  value      String
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  @@index([key])
}

model credit_plans {
  id                  Int                   @id @default(autoincrement())
  name                String
  description         String?
  credits             Int
  price               Decimal               @db.Decimal(10, 2)
  is_active           Boolean               @default(true)
  is_popular          Boolean               @default(false)
  discount            Int                   @default(0)
  order               Int                   @default(0)
  created_at          DateTime              @default(now())
  updated_at          DateTime              @default(now())
  credit_transactions credit_transactions[]
}

model credit_transactions {
  id                Int           @id @default(autoincrement())
  user_id           Int
  user_credit_id    Int
  type              String
  amount            Decimal       @db.Decimal(10, 2)
  balance_before    Decimal       @db.Decimal(10, 2)
  balance_after     Decimal       @db.Decimal(10, 2)
  description       String?
  credit_plan_id    Int?
  session_id        Int?
  payment_status    String?
  payment_method    String?
  payment_reference String?
  created_at        DateTime      @default(now())
  credit_plans      credit_plans? @relation(fields: [credit_plan_id], references: [id])
  user_credits      user_credits  @relation(fields: [user_credit_id], references: [id])

  @@index([payment_status])
  @@index([type])
  @@index([user_credit_id])
  @@index([user_id])
}

model exercise_questions {
  id              Int             @id @default(autoincrement())
  topic_id        Int
  question        String
  answer          String
  explanation     String?
  order           Int             @default(0)
  created_at      DateTime        @default(now())
  updated_at      DateTime        @default(now())
  exercise_topics exercise_topics @relation(fields: [topic_id], references: [id], onDelete: Cascade)

  @@index([order])
  @@index([topic_id])
}

model exercise_sessions {
  id                       Int      @id @default(autoincrement())
  user_learning_session_id Int      @unique
  exercise_topic_id        Int?
  total_question           Int
  credits_used             Int      @default(0)
  number_of_attempts       Int      @default(0)
  created_at               DateTime @default(now())
  updated_at               DateTime @default(now())

  exercise_session_attempts  exercise_session_attempts[]
  user_learning_session      user_learning_sessions       @relation(fields: [user_learning_session_id], references: [id], onDelete: Cascade)
  exercise_session_questions exercise_session_questions[]
  exercise_topic             exercise_topics?             @relation(fields: [exercise_topic_id], references: [id])

  @@index([user_learning_session_id])
  @@index([exercise_topic_id])
}

model exercise_session_questions {
  id                  Int      @id @default(autoincrement())
  exercise_session_id Int
  question_text       String // Snapshot of question at time of session
  answer_text         String // Snapshot of answer at time of session
  explanation         String // Snapshot of explanation at time of session
  order               Int
  created_at          DateTime @default(now())

  exercise_session         exercise_sessions          @relation(fields: [exercise_session_id], references: [id], onDelete: Cascade)
  exercise_session_answers exercise_session_answers[]

  @@index([order])
}

model exercise_session_attempts {
  id                  Int       @id @default(autoincrement())
  exercise_session_id Int
  attempt_number      Int       @default(1)
  status              String    @default("not_started")
  correct_question    Int?
  total_question      Int?
  score               Int       @default(0)
  started_at          DateTime  @default(now())
  completed_at        DateTime?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @default(now())

  exercise_session_answers exercise_session_answers[]
  exercise_session         exercise_sessions          @relation(fields: [exercise_session_id], references: [id], onDelete: Cascade)

  @@index([exercise_session_id])
  @@index([started_at])
  @@index([status])
}

model exercise_session_answers {
  id                           Int      @id @default(autoincrement())
  exercise_session_attempt_id  Int
  exercise_session_question_id Int
  user_answer                  String
  is_correct                   Boolean
  answered_at                  DateTime @default(now())
  time_taken_seconds           Int?

  exercise_session_attempts  exercise_session_attempts  @relation(fields: [exercise_session_attempt_id], references: [id], onDelete: Cascade)
  exercise_session_questions exercise_session_questions @relation(fields: [exercise_session_question_id], references: [id], onDelete: Cascade)

  @@index([answered_at])
  @@index([exercise_session_attempt_id])
  @@index([exercise_session_question_id])
}

model exercise_topic_tags {
  id              Int             @id @default(autoincrement())
  topic_id        Int
  tag_id          Int
  created_at      DateTime        @default(now())
  tags            tags            @relation(fields: [tag_id], references: [id], onDelete: Cascade)
  exercise_topics exercise_topics @relation(fields: [topic_id], references: [id], onDelete: Cascade)

  @@unique([topic_id, tag_id])
  @@index([tag_id])
  @@index([topic_id])
}

model exercise_topics {
  id             Int      @id @default(autoincrement())
  title          String
  description    String?
  content_type   String
  content        String?
  question_count Int?
  status         String   @default("draft")
  is_active      Boolean  @default(true)
  created_by     Int
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now())

  exercise_session    exercise_sessions[]
  exercise_questions  exercise_questions[]
  exercise_topic_tags exercise_topic_tags[]

  @@index([created_by])
  @@index([is_active])
  @@index([status])
}

model tags {
  id           Int      @id @default(autoincrement())
  name         String
  tag_group_id Int?
  is_active    Boolean  @default(true)
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now())

  tag_group tag_groups? @relation(fields: [tag_group_id], references: [id], onDelete: Cascade)

  exercise_topic_tags          exercise_topic_tags[]
  flashcard_deck_tags          flashcard_deck_tags[]
  summary_note_tags            summary_note_tags[]
  calculator_topic_tags        calculator_topic_tags[]
  anatomy_quiz_tags            anatomy_quiz_tags[]
  mcq_topic_tags               mcq_topic_tags[]
  osce_topic_tags              osce_topic_tags[]
  osce_session_topic_snapshots osce_session_tag_snapshots[]

  @@unique([name, tag_group_id])
  @@index([is_active])
}

model tag_groups {
  id         Int      @id @default(autoincrement())
  name       String
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  tags tags[]

  @@unique([name])
}

model user_learning_sessions {
  id         Int      @id @default(autoincrement())
  user_id    Int
  title      String
  type       String   @default("exercise")
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  exercise_session     exercise_sessions?
  flashcard_session    flashcard_sessions?
  summary_note_session summary_note_sessions?

  @@index([title])
  @@index([type])
  @@index([user_id])
}

model flashcard_decks {
  id              Int      @id @default(autoincrement())
  title           String
  description     String?
  content_type    String
  content         String?
  flashcard_count Int?
  status          String   @default("draft")
  is_active       Boolean  @default(true)
  created_by      Int
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  flashcard_cards     flashcard_cards[]
  flashcard_deck_tags flashcard_deck_tags[]
  flashcard_sessions  flashcard_sessions[]

  @@index([created_by])
  @@index([is_active])
  @@index([status])
}

model flashcard_cards {
  id         Int      @id @default(autoincrement())
  deck_id    Int
  front      String
  back       String
  image_url  String?
  order      Int      @default(0)
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  flashcard_decks flashcard_decks @relation(fields: [deck_id], references: [id], onDelete: Cascade)

  @@index([deck_id])
  @@index([order])
}

model flashcard_deck_tags {
  id         Int      @id @default(autoincrement())
  deck_id    Int
  tag_id     Int
  created_at DateTime @default(now())

  flashcard_decks flashcard_decks @relation(fields: [deck_id], references: [id], onDelete: Cascade)
  tags            tags            @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([deck_id, tag_id])
  @@index([deck_id])
  @@index([tag_id])
}

model flashcard_sessions {
  id                       Int      @id @default(autoincrement())
  user_learning_session_id Int      @unique
  flashcard_deck_id        Int?
  total_cards              Int
  credits_used             Int      @default(0)
  created_at               DateTime @default(now())
  updated_at               DateTime @default(now())

  user_learning_session   user_learning_sessions    @relation(fields: [user_learning_session_id], references: [id], onDelete: Cascade)
  flashcard_deck          flashcard_decks?          @relation(fields: [flashcard_deck_id], references: [id])
  flashcard_session_cards flashcard_session_cards[]

  @@index([user_learning_session_id])
  @@index([flashcard_deck_id])
}

model flashcard_session_cards {
  id                   Int      @id @default(autoincrement())
  flashcard_session_id Int
  original_card_id     Int? // references flashcard_cards.id for progress tracking
  front_text           String
  back_text            String
  order                Int
  created_at           DateTime @default(now())

  flashcard_session flashcard_sessions @relation(fields: [flashcard_session_id], references: [id], onDelete: Cascade)

  @@index([flashcard_session_id])
  @@index([order])
  @@index([original_card_id])
}

// Track user progress per card across all sessions
model user_card_progress {
  id              Int      @id @default(autoincrement())
  user_id         Int
  card_id         Int // references flashcard_cards.id
  times_correct   Int      @default(0)
  times_incorrect Int      @default(0)
  last_reviewed   DateTime @default(now())
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  @@unique([user_id, card_id])
  @@index([user_id])
  @@index([card_id])
}

model user_question_progress {
  id              Int      @id @default(autoincrement())
  user_id         Int
  question_id     Int // references exercise_questions.id
  topic_id        Int // references exercise_topics.id
  times_correct   Int      @default(0)
  times_incorrect Int      @default(0)
  last_reviewed   DateTime @default(now())
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  @@unique([user_id, question_id])
  @@index([user_id])
  @@index([question_id])
  @@index([topic_id])
}

model user_sessions {
  id                       Int       @id @default(autoincrement())
  user_id                  Int
  token                    String    @unique
  refresh_token            String?   @unique
  refresh_token_expires_at DateTime?
  is_active                Boolean   @default(true)
  user_agent               String?
  ip_address               String?
  expires_at               DateTime
  last_active_at           DateTime  @default(now())
  created_at               DateTime  @default(now())

  @@index([token])
  @@index([refresh_token])
  @@index([user_id])
}

model users {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  name       String?
  picture    String?
  google_id  String?  @unique
  role       String   @default("user")
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  user_credit           user_credits?
  user_subscription     user_subscriptions[]
  user_purchases        user_purchases[]
  chatbot_conversations chatbot_conversations[]
  skripsi_sets          skripsi_sets[]
  osce_sessions         osce_sessions[]
}

model user_subscriptions {
  id         Int      @id @default(autoincrement())
  user_id    Int
  start_date DateTime
  end_date   DateTime
  status     String   @default("active") // 'active', 'not_active', 'expired'
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id, start_date, end_date])
  @@index([status])
}

model user_credits {
  id         Int      @id @default(autoincrement())
  user_id    Int      @unique
  balance    Decimal  @default(0) @db.Decimal(10, 2)
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  user                users                 @relation(fields: [user_id], references: [id], onDelete: Cascade)
  credit_transactions credit_transactions[]

  @@index([user_id])
}

// ============= Summary Notes Feature =============

model summary_notes {
  id               Int     @id @default(autoincrement())
  title            String
  description      String?
  content          String  @db.Text // BlockNote JSON format
  markdown_content String? @db.Text // Markdown format for testing/export

  status     String   @default("draft")
  is_active  Boolean  @default(true)
  created_by Int
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  summary_note_tags     summary_note_tags[]
  summary_note_sessions summary_note_sessions[]

  @@index([created_by])
  @@index([is_active])
  @@index([status])
}

model summary_note_tags {
  id              Int      @id @default(autoincrement())
  summary_note_id Int
  tag_id          Int
  created_at      DateTime @default(now())

  summary_note summary_notes @relation(fields: [summary_note_id], references: [id], onDelete: Cascade)
  tags         tags          @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([summary_note_id, tag_id])
  @@index([summary_note_id])
  @@index([tag_id])
}

model summary_note_sessions {
  id                       Int      @id @default(autoincrement())
  user_learning_session_id Int      @unique
  summary_note_id          Int
  credits_used             Int      @default(0)
  viewed_at                DateTime @default(now())
  created_at               DateTime @default(now())

  user_learning_session user_learning_sessions @relation(fields: [user_learning_session_id], references: [id], onDelete: Cascade)
  summary_note          summary_notes          @relation(fields: [summary_note_id], references: [id])

  @@index([user_learning_session_id])
  @@index([summary_note_id])
}

// ============= Platform Statistics =============

model statistics {
  id         Int      @id @default(autoincrement())
  key        String   @unique
  value      Int      @default(0)
  updated_at DateTime @default(now()) @updatedAt

  @@index([key])
}

// ============= Pricing Plans (Unified Bundles) =============

model pricing_plans {
  id                     Int      @id @default(autoincrement())
  code                   String?  @unique
  name                   String
  description            String?
  price                  Decimal  @db.Decimal(10, 2)
  bundle_type            String   @default("credits") // credits, subscription, hybrid
  duration_days          Int? // for subscription/hybrid bundles
  credits_included       Int      @default(0)
  is_active              Boolean  @default(true)
  is_popular             Boolean  @default(false)
  discount               Int      @default(0)
  order                  Int      @default(0)
  allowed_payment_method String   @default("xendit") // comma-separated: xendit, manual
  created_at             DateTime @default(now())
  updated_at             DateTime @default(now())

  user_purchases user_purchases[]

  @@index([is_active])
  @@index([bundle_type])
  @@index([order])
  @@index([name])
  @@index([code])
  @@index([is_active, bundle_type, order])
}

model user_purchases {
  id              Int      @id @default(autoincrement())
  user_id         Int
  pricing_plan_id Int
  bundle_type     String // credits, subscription, hybrid
  purchase_date   DateTime @default(now())

  // Payment fields
  payment_status    String  @default("completed")
  payment_method    String?
  payment_reference String? // Xendit invoice ID or manual payment reference
  amount_paid       Decimal @db.Decimal(10, 2)
  // Payment evidence is stored via attachments table with name="payment_evidence"

  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  user         users         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  pricing_plan pricing_plans @relation(fields: [pricing_plan_id], references: [id])

  @@index([user_id])
  @@index([pricing_plan_id])
  @@index([bundle_type])
  @@index([payment_status])
}

// ============= Features Configuration =============

model features {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  icon        String?
  access_type String   @default("free") // free, subscription, credits, subscription_and_credits
  credit_cost Int      @default(0)
  is_active   Boolean  @default(true)
  order       Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now())

  @@index([is_active])
  @@index([access_type])
  @@index([order])
}

// ============= Calculator Feature =============

model calculator_topics {
  id                  Int      @id @default(autoincrement())
  title               String
  description         String?
  clinical_references String[] @default([])
  formula             String // JavaScript expression, e.g., "weight * 2" or "(height + weight) / 2"
  result_label        String // Label for the result, e.g., "Total"
  result_unit         String? // Unit for result, e.g., "kg", "cm"
  status              String   @default("draft") // draft, published
  is_active           Boolean  @default(true)
  created_by          Int
  created_at          DateTime @default(now())
  updated_at          DateTime @default(now())

  calculator_fields          calculator_fields[]
  calculator_classifications calculator_classifications[]
  calculator_topic_tags      calculator_topic_tags[]

  @@index([created_by])
  @@index([status])
  @@index([is_active])
}

model calculator_topic_tags {
  id                  Int      @id @default(autoincrement())
  calculator_topic_id Int
  tag_id              Int
  created_at          DateTime @default(now())

  calculator_topic calculator_topics @relation(fields: [calculator_topic_id], references: [id], onDelete: Cascade)
  tags             tags              @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([calculator_topic_id, tag_id])
  @@index([calculator_topic_id])
  @@index([tag_id])
}

model calculator_fields {
  id                  Int      @id @default(autoincrement())
  calculator_topic_id Int
  key                 String // Field key for formula reference, e.g., "weight"
  type                String // number, text, dropdown, radio
  label               String // Display label, e.g., "Berat Badan"
  placeholder         String // Placeholder text for input field
  description         String? // Helpful description
  unit                String? // Unit of measurement, e.g., "kg", "cm"
  order               Int      @default(0)
  is_required         Boolean  @default(true)
  created_at          DateTime @default(now())
  updated_at          DateTime @default(now())

  calculator_topics calculator_topics          @relation(fields: [calculator_topic_id], references: [id], onDelete: Cascade)
  field_options     calculator_field_options[]

  @@unique([calculator_topic_id, key])
  @@index([calculator_topic_id])
  @@index([order])
}

model calculator_field_options {
  id                  Int      @id @default(autoincrement())
  calculator_field_id Int
  value               String // The value submitted when option is selected
  label               String // Display label for the option
  order               Int      @default(0)
  created_at          DateTime @default(now())
  updated_at          DateTime @default(now())

  calculator_field calculator_fields @relation(fields: [calculator_field_id], references: [id], onDelete: Cascade)

  @@index([calculator_field_id])
  @@index([order])
}

model calculator_classifications {
  id                  Int      @id @default(autoincrement())
  calculator_topic_id Int
  name                String   @default("Classification Group") // Classification group name, e.g., "Kategori BMI"
  order               Int      @default(0)
  created_at          DateTime @default(now())
  updated_at          DateTime @default(now())

  calculator_topics calculator_topics                   @relation(fields: [calculator_topic_id], references: [id], onDelete: Cascade)
  options           calculator_classification_options[]

  @@index([calculator_topic_id])
  @@index([order])
}

model calculator_classification_options {
  id                           Int      @id @default(autoincrement())
  calculator_classification_id Int
  value                        String   @default("classification") // Classification value, e.g., "underweight"
  label                        String   @default("Classification") // Classification label, e.g., "Underweight"
  order                        Int      @default(0)
  created_at                   DateTime @default(now())
  updated_at                   DateTime @default(now())

  calculator_classification calculator_classifications                    @relation(fields: [calculator_classification_id], references: [id], onDelete: Cascade)
  conditions                calculator_classification_option_conditions[]

  @@index([calculator_classification_id])
  @@index([order])
}

model calculator_classification_option_conditions {
  id                                  Int      @id @default(autoincrement())
  calculator_classification_option_id Int
  result_key                          String // The key to check (usually "result" but could be specific field)
  operator                            String // >, <, >=, <=, ==, !=
  value                               String // The value to compare against
  logical_operator                    String? // AND, OR (null for last condition)
  order                               Int      @default(0)
  created_at                          DateTime @default(now())
  updated_at                          DateTime @default(now())

  calculator_classification_option calculator_classification_options @relation(fields: [calculator_classification_option_id], references: [id], onDelete: Cascade)

  @@index([calculator_classification_option_id])
  @@index([order])
}

model attachments {
  id          Int      @id @default(autoincrement())
  name        String
  record_type String
  record_id   Int
  blob_id     Int
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now())

  blob blobs @relation(fields: [blob_id], references: [id], onDelete: Cascade)

  @@index([record_type, record_id, name])
  @@index([blob_id])
}

model blobs {
  id           Int      @id @default(autoincrement())
  key          String
  filename     String
  metadata     String
  content_type String
  byte_size    Int
  checksum     String
  uploaded_at  DateTime @default(now())
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now())

  attachments attachments[]

  @@index([key])
  @@index([checksum])
}

// ============= Anatomy Quiz Feature =============

model anatomy_quizzes {
  id             Int      @id @default(autoincrement())
  title          String
  description    String?
  status         String   @default("draft")
  is_active      Boolean  @default(true)
  question_count Int      @default(0)
  created_by     Int
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now())

  anatomy_questions     anatomy_questions[]
  anatomy_quiz_tags     anatomy_quiz_tags[]
  anatomy_quiz_attempts anatomy_quiz_attempts[]

  @@index([created_by])
  @@index([is_active])
  @@index([status])
}

model anatomy_questions {
  id          Int      @id @default(autoincrement())
  quiz_id     Int
  question    String
  answer      String
  answer_type String   @default("text") // 'text' or 'multiple_choice'
  choices     Json? // Array of choice options for multiple_choice questions
  order       Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now())

  anatomy_quiz         anatomy_quizzes        @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  anatomy_quiz_answers anatomy_quiz_answers[]

  @@index([quiz_id])
  @@index([order])
}

model anatomy_quiz_tags {
  id         Int      @id @default(autoincrement())
  quiz_id    Int
  tag_id     Int
  created_at DateTime @default(now())

  anatomy_quiz anatomy_quizzes @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  tags         tags            @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([quiz_id, tag_id])
  @@index([quiz_id])
  @@index([tag_id])
}

// Simplified attempt tracking - no sessions
model anatomy_quiz_attempts {
  id              Int       @id @default(autoincrement())
  user_id         Int
  quiz_id         Int
  status          String    @default("in_progress") // in_progress, completed
  correct_count   Int       @default(0)
  total_questions Int
  score           Int       @default(0)
  started_at      DateTime  @default(now())
  completed_at    DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @default(now())

  anatomy_quiz         anatomy_quizzes        @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  anatomy_quiz_answers anatomy_quiz_answers[]

  @@index([user_id])
  @@index([quiz_id])
  @@index([status])
}

model anatomy_quiz_answers {
  id               Int      @id @default(autoincrement())
  attempt_id       Int
  question_id      Int // Direct reference to anatomy_questions
  user_answer      String
  is_correct       Boolean
  similarity_score Float?
  answered_at      DateTime @default(now())

  anatomy_quiz_attempt anatomy_quiz_attempts @relation(fields: [attempt_id], references: [id], onDelete: Cascade)
  anatomy_question     anatomy_questions     @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@index([attempt_id])
  @@index([question_id])
}

model user_anatomy_progress {
  id              Int      @id @default(autoincrement())
  user_id         Int
  question_id     Int
  quiz_id         Int
  times_correct   Int      @default(0)
  times_incorrect Int      @default(0)
  last_reviewed   DateTime @default(now())
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  @@unique([user_id, question_id])
  @@index([user_id])
  @@index([question_id])
  @@index([quiz_id])
}

// ============= Multiple Choice Quiz (MCQ) Feature =============

model mcq_topics {
  id              Int      @id @default(autoincrement())
  title           String
  description     String?
  content_type    String // 'pdf', 'text', 'manual'
  content         String?
  question_count  Int?
  source_url      String?
  source_key      String?
  source_filename String?
  quiz_time_limit Int      @default(0) // in minutes, 0 = no limit
  passing_score   Int      @default(70) // percentage
  status          String   @default("draft") // draft, published
  is_active       Boolean  @default(true)
  created_by      Int
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  mcq_questions  mcq_questions[]
  mcq_topic_tags mcq_topic_tags[]
  mcq_attempts   mcq_attempts[]

  @@index([created_by])
  @@index([is_active])
  @@index([status])
}

model mcq_questions {
  id             Int      @id @default(autoincrement())
  topic_id       Int
  question       String
  image_url      String?
  image_key      String?
  image_filename String?
  options        Json // Array of option strings
  correct_answer Int // Index of correct option (0-based)
  explanation    String?
  order          Int      @default(0)
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now())

  mcq_topic         mcq_topics          @relation(fields: [topic_id], references: [id], onDelete: Cascade)
  mcq_answers       mcq_answers[]
  user_mcq_progress user_mcq_progress[]

  @@index([topic_id])
  @@index([order])
}

model mcq_topic_tags {
  id         Int      @id @default(autoincrement())
  topic_id   Int
  tag_id     Int
  created_at DateTime @default(now())

  mcq_topic mcq_topics @relation(fields: [topic_id], references: [id], onDelete: Cascade)
  tags      tags       @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([topic_id, tag_id])
  @@index([topic_id])
  @@index([tag_id])
}

model mcq_attempts {
  id              Int       @id @default(autoincrement())
  user_id         Int
  topic_id        Int
  mode            String // 'learning' or 'quiz'
  status          String    @default("in_progress") // in_progress, completed
  score           Int       @default(0)
  total_questions Int
  correct_count   Int       @default(0)
  time_spent      Int? // in seconds
  started_at      DateTime  @default(now())
  completed_at    DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @default(now())

  mcq_topic   mcq_topics    @relation(fields: [topic_id], references: [id], onDelete: Cascade)
  mcq_answers mcq_answers[]

  @@index([user_id])
  @@index([topic_id])
  @@index([status])
}

model mcq_answers {
  id          Int      @id @default(autoincrement())
  attempt_id  Int
  question_id Int
  user_answer Int // Index of selected option (0-based)
  is_correct  Boolean
  answered_at DateTime @default(now())
  time_taken  Int? // in seconds

  mcq_attempt  mcq_attempts  @relation(fields: [attempt_id], references: [id], onDelete: Cascade)
  mcq_question mcq_questions @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@index([attempt_id])
  @@index([question_id])
}

model user_mcq_progress {
  id              Int      @id @default(autoincrement())
  user_id         Int
  question_id     Int
  topic_id        Int
  times_correct   Int      @default(0)
  times_incorrect Int      @default(0)
  last_reviewed   DateTime @default(now())
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  mcq_question mcq_questions @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@unique([user_id, question_id])
  @@index([user_id])
  @@index([question_id])
  @@index([topic_id])
}

// ============= Chatbot Feature =============

model chatbot_conversations {
  id         Int      @id @default(autoincrement())
  user_id    Int
  topic      String
  is_deleted Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  users            users              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  chatbot_messages chatbot_messages[]

  @@index([user_id])
  @@index([created_at])
  @@index([updated_at])
  @@index([is_deleted])
  @@index([user_id, is_deleted, updated_at]) // Composite index for listing user conversations
}

model chatbot_messages {
  id              Int      @id @default(autoincrement())
  conversation_id Int
  sender_type     String // 'user' or 'ai'
  mode_type       String? // 'normal', 'validated', 'research' (null for user messages)
  content         String   @db.Text
  credits_used    Int      @default(0)
  is_deleted      Boolean  @default(false)
  created_at      DateTime @default(now())

  chatbot_conversation      chatbot_conversations       @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  chatbot_message_sources   chatbot_message_sources[]
  chatbot_message_feedbacks chatbot_message_feedbacks[]

  @@index([conversation_id])
  @@index([sender_type])
  @@index([mode_type])
  @@index([created_at])
  @@index([is_deleted])
  @@index([conversation_id, created_at]) // Composite index for message listing
}

model chatbot_message_sources {
  id          Int      @id @default(autoincrement())
  message_id  Int
  source_type String // 'summary_note', 'web_search'
  title       String
  content     String   @db.Text
  url         String?
  score       Float? // Similarity/relevance score
  created_at  DateTime @default(now())

  chatbot_message chatbot_messages @relation(fields: [message_id], references: [id], onDelete: Cascade)

  @@index([message_id])
  @@index([source_type])
}

model chatbot_message_feedbacks {
  id         Int      @id @default(autoincrement())
  message_id Int
  user_id    Int
  is_helpful Boolean
  feedback   String?  @db.Text
  created_at DateTime @default(now())

  chatbot_message chatbot_messages @relation(fields: [message_id], references: [id], onDelete: Cascade)

  @@unique([message_id, user_id]) // One feedback per user per message
  @@index([message_id])
  @@index([user_id])
  @@index([is_helpful])
}

// Skripsi Builder Tables
model skripsi_sets {
  id             Int      @id @default(autoincrement())
  user_id        Int
  title          String
  description    String?  @db.Text
  editor_content String?  @db.Text
  created_at     DateTime @default(now())
  updated_at     DateTime @default(now())
  is_deleted     Boolean  @default(false)

  users users          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  tabs  skripsi_tabs[]

  @@index([user_id])
  @@index([is_deleted])
}

model skripsi_tabs {
  id         Int      @id @default(autoincrement())
  set_id     Int
  tab_type   String // 'ai_researcher_1', 'ai_researcher_2', 'ai_researcher_3', 'paraphraser', 'diagram_builder'
  title      String?
  content    String?  @db.Text
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  skripsi_set skripsi_sets       @relation(fields: [set_id], references: [id], onDelete: Cascade)
  messages    skripsi_messages[]
  diagrams    skripsi_diagrams[]

  @@index([set_id])
  @@index([tab_type])
}

model skripsi_messages {
  id          Int      @id @default(autoincrement())
  tab_id      Int
  sender_type String // 'user' or 'ai'
  content     String   @db.Text
  created_at  DateTime @default(now())

  skripsi_tab skripsi_tabs @relation(fields: [tab_id], references: [id], onDelete: Cascade)

  @@index([tab_id])
  @@index([sender_type])
}

model skripsi_diagrams {
  id              Int      @id @default(autoincrement())
  tab_id          Int
  diagram_type    String?  // 'flowchart', 'mindmap', etc. (nullable for manual diagrams)
  detail_level    String?  // 'simple', 'medium', 'detailed' (nullable for manual diagrams)
  orientation     String?  // 'vertical', 'horizontal' (nullable for manual diagrams)
  layout_style    String?  // 'branch', 'linear', 'tree' (nullable for manual diagrams)
  description     String?  @db.Text // User's input description (nullable for manual diagrams)
  diagram_data    String   @db.Text // Excalidraw JSON
  creation_method String   @default("ai_generated") // 'ai_generated' or 'manual'
  credits_used    Decimal  @default(0) @db.Decimal(10, 2)
  created_at      DateTime @default(now())

  skripsi_tab skripsi_tabs @relation(fields: [tab_id], references: [id], onDelete: Cascade)

  @@index([tab_id])
  @@index([diagram_type])
  @@index([created_at])
  @@index([creation_method])
}

model skripsi_constants {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String   @db.Text
  description String?  @db.Text
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now())

  @@index([key])
}

// ============= OSCE Practice Feature =============

model osce_topics {
  id               Int      @id @default(autoincrement())
  title            String
  description      String?
  scenario         String   @db.Text // The OSCE case/scenario
  guide            String?  @db.Text // Guide or instructions for students
  context          String?  @db.Text // Additional context or background
  answer_key       String?  @db.Text // Expected answers or key points
  knowledge_base   Json? // Key-value pairs of knowledge items
  ai_model         String // AI model for this topic (e.g., 'gemini-1.5-pro', 'gpt-4o')
  osce_rubric_id   Int
  duration_minutes Int // Recommended practice duration
  status           String   @default("draft") // draft, published
  is_active        Boolean  @default(true)
  created_by       Int
  created_at       DateTime @default(now())
  updated_at       DateTime @default(now())

  osce_topic_tags               osce_topic_tags[]
  osce_sessions                 osce_sessions[]
  osce_topic_observations       osce_topic_observations[]
  osce_rubric                   osce_rubrics?                   @relation(fields: [osce_rubric_id], references: [id])
  osce_session_rubric_snapshots osce_session_rubric_snapshots[]

  @@index([created_by])
  @@index([osce_rubric_id])
  @@index([status])
  @@index([is_active])
}

model osce_topic_tags {
  id         Int      @id @default(autoincrement())
  topic_id   Int
  tag_id     Int
  created_at DateTime @default(now())

  osce_topic osce_topics @relation(fields: [topic_id], references: [id], onDelete: Cascade)
  tags       tags        @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@unique([topic_id, tag_id])
  @@index([topic_id])
  @@index([tag_id])
}

model osce_rubrics {
  id         Int      @id @default(autoincrement())
  name       String // e.g., "LABORATORIUM", "RADIOLOGI", etc.
  content    String   @db.Text // e.g., "LABORATORIUM", "RADIOLOGI", etc.
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  osce_topics                   osce_topics[]
  osce_session_rubric_snapshots osce_session_rubric_snapshots[]

  @@unique([name])
}

model osce_observation_groups {
  id         Int      @id @default(autoincrement())
  name       String // e.g., "LABORATORIUM", "RADIOLOGI", etc.
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  osce_observations osce_observations[]
}

model osce_observations {
  id         Int      @id @default(autoincrement())
  group_id   Int // Reference to observation group
  name       String // e.g., "ASTO", "Analisis LCS", "Apusan Darah Tepi"
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  osce_observation_group  osce_observation_groups   @relation(fields: [group_id], references: [id], onDelete: Cascade)
  osce_topic_observations osce_topic_observations[]

  @@index([group_id])
}

// Junction table linking topics to observations with additional context
model osce_topic_observations {
  id                      Int      @id @default(autoincrement())
  topic_id                Int
  observation_id          Int
  observation_text        String?  @db.Text // Context/description for this observation in this topic
  requires_interpretation Boolean  @default(false) // Whether user needs to interpret the observation
  created_at              DateTime @default(now())
  updated_at              DateTime @default(now())

  osce_topic       osce_topics       @relation(fields: [topic_id], references: [id], onDelete: Cascade)
  osce_observation osce_observations @relation(fields: [observation_id], references: [id], onDelete: Cascade)

  @@unique([topic_id, observation_id])
  @@index([topic_id])
  @@index([observation_id])
}

model osce_sessions {
  id                  Int       @id @default(autoincrement())
  unique_id           String    @unique @default(uuid())
  user_id             Int
  osce_topic_id       Int // Reference to original topic (for admin purposes)
  status              String    @default("created") // created, started, completed
  time_taken          Int       @default(0) // Actual time spent by user
  total_score         Int?
  max_score           Int?
  ai_feedback         String?   @db.Text // Overall feedback from AI
  credits_used        Int       @default(0)
  observations_locked Boolean   @default(false) // Whether user has saved observations (cannot change after)
  scheduled_end_at    DateTime? // When the session is expected to end (based on duration)
  started_at          DateTime? // When the session actually started (after preparation)
  created_at          DateTime  @default(now())
  updated_at          DateTime  @default(now())

  user                                     users                                      @relation(fields: [user_id], references: [id])
  osce_topic                               osce_topics                                @relation(fields: [osce_topic_id], references: [id])
  osce_session_rubric_snapshots            osce_session_rubric_snapshots[]
  osce_session_tag_snapshots               osce_session_tag_snapshots[]
  osce_session_topic_snapshot              osce_session_topic_snapshots?
  osce_session_observation_group_snapshots osce_session_observation_group_snapshots[]
  osce_session_observations                osce_session_observations[]
  osce_session_messages                    osce_session_messages[]
  osce_session_diagnoses                   osce_session_diagnoses[]
  osce_session_therapies                   osce_session_therapies[]

  @@index([unique_id])
  @@index([user_id])
  @@index([osce_topic_id])
  @@index([status])
}

// Snapshot of topic data at session creation time
model osce_session_topic_snapshots {
  id               Int      @id @default(autoincrement())
  osce_session_id  Int      @unique
  title            String
  description      String?
  scenario         String   @db.Text
  guide            String?  @db.Text
  context          String?  @db.Text
  answer_key       String?  @db.Text
  knowledge_base   Json?
  ai_model         String
  duration_minutes Int
  created_at       DateTime @default(now())

  osce_session osce_sessions @relation(fields: [osce_session_id], references: [id], onDelete: Cascade)

  @@index([osce_session_id])
}

model osce_session_tag_snapshots {
  id              Int @id @default(autoincrement())
  osce_session_id Int
  tag_id          Int

  osce_session osce_sessions @relation(fields: [osce_session_id], references: [id], onDelete: Cascade)
  tags         tags          @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@index([osce_session_id, tag_id])
  @@index([tag_id])
}

// Snapshot of observation groups at session creation time
model osce_session_observation_group_snapshots {
  id               Int       @id @default(autoincrement())
  osce_session_id  Int
  group_id         Int // Original group ID for reference
  group_name       String // Snapshot of group name
  group_created_at DateTime? // Snapshot of original created_at
  group_updated_at DateTime? // Snapshot of original updated_at
  created_at       DateTime  @default(now())

  osce_session                       osce_sessions                        @relation(fields: [osce_session_id], references: [id], onDelete: Cascade)
  osce_session_observation_snapshots osce_session_observation_snapshots[]

  @@index([osce_session_id, group_name])
  @@index([group_id])
}

// Snapshot of observations at session creation time
model osce_session_observation_snapshots {
  id                      Int       @id @default(autoincrement())
  group_snapshot_id       Int // Reference to group snapshot
  observation_id          Int?      @default(0) // Original observation ID
  observation_group_id    Int? // Snapshot of original group_id from observation
  observation_name        String?   @default("") // Snapshot of observation name
  observation_created_at  DateTime? // Snapshot of original observation created_at
  observation_updated_at  DateTime? // Snapshot of original observation updated_at
  observation_text        String?   @db.Text // Snapshot of observation context/description from topic
  requires_interpretation Boolean   @default(false) // Snapshot of interpretation requirement from topic
  topic_observation_order Int       @default(0) // Snapshot of order from topic
  created_at              DateTime  @default(now())

  group_snapshot       osce_session_observation_group_snapshots @relation(fields: [group_snapshot_id], references: [id], onDelete: Cascade)
  session_observations osce_session_observations[]

  @@index([observation_id])
  @@index([group_snapshot_id, observation_name])
}

model osce_session_rubric_snapshots {
  id              Int      @id @default(autoincrement())
  osce_session_id Int
  rubric_id       Int
  name            String
  content         String   @db.Text
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  osce_topics osce_topics[]

  osce_rubric  osce_rubrics?  @relation(fields: [rubric_id], references: [id], onDelete: Cascade)
  osce_session osce_sessions? @relation(fields: [osce_session_id], references: [id], onDelete: Cascade)

  @@index([rubric_id])
  @@index([osce_session_id])
}

// User's interaction with observations during the session
model osce_session_observations {
  id                      Int      @id @default(autoincrement())
  osce_session_id         Int
  observation_snapshot_id Int // Reference to observation snapshot
  interpretation          String?  @db.Text // Optional notes about this observation
  created_at              DateTime @default(now())

  osce_session         osce_sessions                      @relation(fields: [osce_session_id], references: [id], onDelete: Cascade)
  observation_snapshot osce_session_observation_snapshots @relation(fields: [observation_snapshot_id], references: [id], onDelete: Cascade)

  @@unique([osce_session_id, observation_snapshot_id])
  @@index([osce_session_id])
  @@index([observation_snapshot_id])
}

model osce_session_messages {
  id              Int      @id @default(autoincrement())
  osce_session_id Int
  sender_type     String // 'user' or 'ai'
  content         String   @db.Text
  credits_used    Int      @default(0)
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  osce_session osce_sessions @relation(fields: [osce_session_id], references: [id], onDelete: Cascade)

  @@index([osce_session_id])
  @@index([sender_type])
  @@index([created_at])
}

model osce_session_diagnoses {
  id              Int      @id @default(autoincrement())
  osce_session_id Int
  type            String // 'utama' or 'pembanding'
  diagnosis       String   @db.Text
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  osce_session osce_sessions @relation(fields: [osce_session_id], references: [id], onDelete: Cascade)

  @@index([osce_session_id])
  @@index([type])
}

model osce_session_therapies {
  id              Int      @id @default(autoincrement())
  osce_session_id Int
  therapy         String   @db.Text
  order           Int      @default(0)
  created_at      DateTime @default(now())
  updated_at      DateTime @default(now())

  osce_session osce_sessions @relation(fields: [osce_session_id], references: [id], onDelete: Cascade)

  @@index([osce_session_id])
  @@index([order])
}
