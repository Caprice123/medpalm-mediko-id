generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model constants {
  id         Int      @id @default(autoincrement())
  key        String   @unique
  value      String
  created_at DateTime @default(now())
  updated_at DateTime @default(now())

  @@index([key])
}

model credit_plans {
  id                  Int                   @id @default(autoincrement())
  name                String
  description         String?
  credits             Int
  price               Decimal               @db.Decimal(10, 2)
  isActive            Boolean               @default(true)
  isPopular           Boolean               @default(false)
  discount            Int                   @default(0)
  order               Int                   @default(0)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now())
  credit_transactions credit_transactions[]
}

model credit_transactions {
  id               Int           @id @default(autoincrement())
  userId           Int
  userCreditId     Int
  type             String
  amount           Int
  balanceBefore    Int
  balanceAfter     Int
  description      String?
  creditPlanId     Int?
  sessionId        Int?
  paymentStatus    String?
  paymentMethod    String?
  paymentReference String?
  createdAt        DateTime      @default(now())
  credit_plans     credit_plans? @relation(fields: [creditPlanId], references: [id])
  user_credits     user_credits  @relation(fields: [userCreditId], references: [id])

  @@index([paymentStatus])
  @@index([type])
  @@index([userCreditId])
  @@index([userId])
}

model exercise_questions {
  id              Int             @id @default(autoincrement())
  topic_id        Int
  question        String
  answer          String
  explanation     String
  order           Int             @default(0)
  created_at      DateTime        @default(now())
  updated_at      DateTime        @default(now())
  exercise_topics exercise_topics @relation(fields: [topic_id], references: [id], onDelete: Cascade)

  @@index([order])
  @@index([topic_id])
}

model exercise_sessions {
    id                       Int                        @id @default(autoincrement())
    user_learning_session_id Int                        @unique
    exercise_topic_id        Int?
    total_question           Int
    credits_used             Int                        @default(0)
    number_of_attempts       Int                        @default(0)
    created_at               DateTime                   @default(now())
    updated_at               DateTime                   @default(now())
    
    exercise_session_attempts   exercise_session_attempts[]
    user_learning_session       user_learning_sessions          @relation(fields: [user_learning_session_id], references: [id], onDelete: Cascade)
    exercise_session_questions  exercise_session_questions[]
    exercise_topic              exercise_topics?                @relation(fields: [exercise_topic_id], references: [id])

    @@index([user_learning_session_id])
    @@index([exercise_topic_id])
}


model exercise_session_questions {
    id                           Int                        @id @default(autoincrement())
    exercise_session_id          Int
    question_text                String
    answer_text                  String
    explanation                  String
    order                        Int
    created_at                   DateTime                   @default(now())

    exercise_session             exercise_sessions  @relation(fields: [exercise_session_id], references: [id], onDelete: Cascade)
    exercise_session_answers     exercise_session_answers[]

    @@index([order])
}

model exercise_session_attempts {
    id                          Int                           @id @default(autoincrement())
    exercise_session_id         Int
    attempt_number              Int                           @default(1)
    status                      String                        @default("not_started")
    correct_question            Int?
    total_question              Int?
    score                       Int                           @default(0)
    started_at                  DateTime                      @default(now())
    completed_at                DateTime?
    created_at                  DateTime                      @default(now())
    updated_at                  DateTime                      @default(now())

    exercise_session_answers    exercise_session_answers[]
    exercise_session            exercise_sessions             @relation(fields: [exercise_session_id], references: [id], onDelete: Cascade)

    @@index([exercise_session_id])
    @@index([started_at])
    @@index([status])
}


model exercise_session_answers {
    id                           Int                          @id @default(autoincrement())
    exercise_session_attempt_id  Int
    exercise_session_question_id Int
    user_answer                  String
    is_correct                   Boolean
    answered_at                  DateTime                     @default(now())
    time_taken_seconds           Int?

    exercise_session_attempts    exercise_session_attempts    @relation(fields: [exercise_session_attempt_id], references: [id], onDelete: Cascade)
    exercise_session_questions   exercise_session_questions   @relation(fields: [exercise_session_question_id], references: [id], onDelete: Cascade)

    @@index([answered_at])
    @@index([exercise_session_attempt_id])
    @@index([exercise_session_question_id])
}

model exercise_topic_tags {
    id              Int             @id @default(autoincrement())
    topic_id        Int
    tag_id          Int
    created_at      DateTime        @default(now())
    tags            tags            @relation(fields: [tag_id], references: [id], onDelete: Cascade)
    exercise_topics exercise_topics @relation(fields: [topic_id], references: [id], onDelete: Cascade)

    @@unique([topic_id, tag_id])
    @@index([tag_id])
    @@index([topic_id])
}

model exercise_topics {
  id                        Int                        @id @default(autoincrement())
  title                     String
  description               String?
  content_type              String
  content                   String?
  pdf_url                   String?
  pdf_key                   String?
  pdf_filename              String?
  status                    String                     @default("draft")
  is_active                 Boolean                    @default(true)
  created_by                Int
  created_at                DateTime                   @default(now())
  updated_at                DateTime                   @default(now())
  
  exercise_session          exercise_sessions[]
  exercise_questions        exercise_questions[]
  exercise_topic_tags       exercise_topic_tags[]

  @@index([created_by])
  @@index([is_active])
  @@index([status])
}

model tags {
  id                  Int                   @id @default(autoincrement())
  name                String
  type                String
  is_active           Boolean               @default(true)
  created_at          DateTime              @default(now())
  updated_at          DateTime              @default(now())
  exercise_topic_tags exercise_topic_tags[]

  @@unique([name, type])
  @@index([is_active])
  @@index([type])
}

model user_credits {
  id                  Int                   @id @default(autoincrement())
  userId              Int                   @unique
  balance             Int                   @default(0)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @default(now())
  credit_transactions credit_transactions[]

  @@index([userId])
}

model user_learning_sessions {
  id                Int                 @id @default(autoincrement())
  user_id           Int
  title             String
  type              String              @default("exercise")
  created_at        DateTime            @default(now())
  updated_at        DateTime            @default(now())

  exercise_session exercise_sessions?

  @@index([title])
  @@index([type])
  @@index([user_id])
}

model user_sessions {
  id           Int      @id @default(autoincrement())
  userId       Int
  token        String   @unique
  isActive     Boolean  @default(true)
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model users {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  picture   String?
  googleId  String?  @unique
  role      String   @default("user")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}
